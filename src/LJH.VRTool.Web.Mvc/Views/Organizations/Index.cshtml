@using Webdiyer.AspNetCore;
@model PagedList<LJH.VRTool.Users.Dto.UserDto>
@section styles{
    <script src="~/lib/krpano/hplus/js/jquery.min.js"></script>
    <link href="~/lib/krpano/hplus/js/plugins/layui/css/mymodules/dtree.css" rel="stylesheet" />
    <link href="~/lib/krpano/hplus/js/plugins/layui/font/dtree/font/dtreefont.css" rel="stylesheet" />
    <link href="~/lib/krpano/hplus/js/plugins/layui/css/mymodules/checkbox.css" rel="stylesheet" />
    <style>
        .layui-tab-content {
            padding-left: 50px;
        }

        .file-option, .file-name {
            text-align: center
        }

        .upload-button-container {
            margin: 15px 0;
        }

        .organizationtree {
            padding: 12px 5px;
            color: #293846;
            background-color: #f2f2f2;
        }
            /*.organizationtree h2{

        }*/
            .organizationtree span {
                display: inline;
                font-size: 15px;
            }

        .jstree-position {
            position: absolute;
            height: 100%;
            border-right: 1px solid #e2e2e2;
        }

        .tree-selected {
            background-color: #293846;
        }

        .tree-dl dl dd span {
            display: none;
        }

        .tree-dl dl:hover dd span {
            display: block;
            bottom: 22px;
            right: 6px;
            position: relative;
        }

        #tab-audio .file-box {
            width: 334px;
        }
    </style>
}
     <div class="wrapper wrapper-content">
    <div id="tree" class="jstree jstree-2 jstree-default jstree-position">
        <div class="organizationtree" style="text-align:center">
            <i class="layui-icon layui-icon-add-circle-fine">
            </i>
            <span onclick="add()">新建根节点</span>
        </div>
        <div style="overflow: auto;" id="toolbarDiv">
            <ul id="organization" class="dtree" data-id="0"></ul>
        </div>
    </div>
    <div style="margin-left:270px">
        <div class="ibox-content">
            <form id="searchForm" asp-action="Index" asp-controller="Organizations" data-ajax="true" data-ajax-method="POST" data-ajax-begin="begin" data-ajax-success="success" data-ajax-mode="replace" data-ajax-update="#ajaxresult">
                <blockquote class="layui-elem-quote-ext">
                    @*<div id="OrganizationIdCon">

                    </div>*@
                    <input type="hidden" name="OrganizationId" id="OrganizationId" value="1"/>
                    <div class="layui-inline">
                        <label class="layui-form-label-ext">日期范围:</label>
                        <div class="layui-input-inline" style="width: 120px;">
                            <input type="text" onfocus="WdatePicker({ maxDate:'#F{$dp.$D(\'TimeMin\')||\'%y-%M-%d\'}' })" id="TimeMin" name="TimeMin" class="lay-input-ext lay-input-time-ext Wdate">
                        </div>
                        <div class="layui-input-inline" style="width: 120px;">
                            <input type="text" onfocus="WdatePicker({ minDate:'#F{$dp.$D(\'TimeMax\')}',maxDate:'%y-%M-%d' })" id="TimeMax" name="TimeMax" class="lay-input-ext lay-input-time-ext Wdate">
                        </div>
                    </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="text" id="KeyWord" name="KeyWord" placeholder="请输入关键字" class="lay-input-ext">
                            </div>
                            <a class="layui-btn-ext layui-btnnobg-ext " onclick="searchList()">
                                <i class="layui-icon layui-icon-search">
                                </i>查询
                            </a>
                        </div>
                    @if (IsGranted(LJH.VRTool.Authorization.PermissionNames.Pages_Users_CreateAct))
                    {
                        <div class="layui-inline">
                            <a class="layui-btn-ext layui-btnnobg-ext" onclick="addUser()">
                                <i class="layui-icon layui-icon-add-circle-fine">
                                </i>添加
                            </a>
                        </div>
                    }
                    @if (IsGranted(LJH.VRTool.Authorization.PermissionNames.Pages_Users_BatchDeleteAct))
                    {
                        <div class="layui-inline">
                            <a class="layui-btn-ext layui-btn-dangernobg-ext" onclick="batchdeleted()">
                                <i class="layui-icon layui-icon-delete">
                                </i>批量删除
                            </a>
                        </div>
                    }
                </blockquote>
            </form>
            <div class="table-responsive animated fadeInRight layui-form" id="ajaxresult">
                <partial name="List" model="@Model" />
            </div>
        </div>
    </div>
</div>
@section scripts
    {
    <script src="~/lib/krpano/hplus/js/plugins/layui/layui.js"></script>
    <script src="~/lib/krpano/hplus/js/plugins/layui/layui.all.js"></script>
    <script src="~/lib/krpano/hplus/js/plugins/layui/lay/mymodules/dtree.js"></script>
    <script>
    var dtree = layui.dtree;
     //获取组织机构
    var getOrganization = function () {
        $.ajax({
            url: '@Url.Action("GetOrganizationData", "Organizations")',
            type: "POST",
            dataType: "json",
            success: function (res) {
                if (res.result.status == "ok") {
                    DTree(res.result.data);
                }
            },
            error: function (e) {
                        layer.msg('请求出错!', { icon: 3, time: 5000 });
                 }
        });
    };
    // layui树渲染
    var DTree = function (res) {
        var s=JSON.parse(res)
            dtree.render({
                elem: "#organization",
                toolbar:true,
                data:s,
                line: true,
                nodeIconArray: {"3":{"open":"dtree-icon-jian1","close":"dtree-icon-jia1"}},
                ficon: ["3", "-1"],
                icon: "0",  //修改二级图标样式
                toolbarFun: {
                    addTreeNode: function (treeNode, $div) {
                        var data = {
                            disPlayName: treeNode.addNodeName,
                            parentId: treeNode.parentId
                        };
                        $.ajax({
                            type: "post",
                            data: data,
                            dataType: "json",
                            url: "@Url.Action("Add", "Organizations")",
                            success: function (res) {
                                if (res.result.status == "ok") {
                                    dtree.reload("organization");
                                }
                            },
                            error: function () {

                            }
                        });
                    },
                    editTreeNode: function (treeNode, $div) {
                        var data = {
                            Id: treeNode.nodeId,
                            disPlayName: treeNode.editNodeName
                        };
                        $.ajax({
                            type: "post",
                            data: data,
                            dataType: "json",
                            url: "@Url.Action("Edit", "Organizations")",
                            success: function (res) {

                            },
                            error: function () {
                            }
                        });
                    },
                    delTreeNode: function (treeNode, $div) {
                        var data = {
                            Id: treeNode.nodeId
                        };
                        $.ajax({
                            type: "post",
                            data: data,
                            url: "@Url.Action("Delete", "Organizations")",
                            success: function (res) {
                                if (res.result.status == "ok") {
                                    dtree.reload("organization");
                                }
                            },
                            error: function () {

                            }
                        });
                    }
                }
            });
     };
    //添加根节点
    var add = function () {
            layer.open({
                anim: 3,
                type: 2,
                title: '添加根组织',
                shadeClose: true,
                shade: 0.8,
                area: ['600px', '600px'],
                content: '/Organizations/Add'
            });
    };
    var addUser = function () {
       layer.open({
                anim: 3,
                type: 2,
                title: '添加根组织',
                shadeClose: true,
                shade: 0.8,
                area: ['600px', '600px'],
                content: '/Organizations/AddUser'
        });
    };
    var searchList = function () {
       $("#searchForm").submit();
    };
    $(function () {
        //getOrganization();
         DTree('@Html.Raw(Json.Serialize(ViewBag.Org))')
         dtree.on("node('organization')", function (obj) {
                 //清空搜索条件
                 $("#OrganizationId").val(obj.param.nodeId);
                 $("#searchForm").submit();
         });
    });
    var begin = function () {
       var index = layer.load();
       layer.load(index);
    };
    var success = function () {

        dtree.on("node('organization')", function (obj) {
                 //清空搜索条件
                 $("#OrganizationId").val(obj.param.nodeId);
                 $("#searchForm").submit();
             });
        var index = layer.load();
        layer.close(index);
    };
    </script>
}
